# `mini-vue`

â³ é€æ¸å®ç° `Vue.js` å¤§éƒ¨åˆ†åŠŸèƒ½

# ç›®å½•ç»“æ„

- `scripts`

  - `rollup.config.dev.js` æœ¬åœ°å¼€å‘
  - `rollup.config.port.js` æ‰“åŒ…

- `src`
  - `examples` æœ¬åœ°å¼€å‘é»˜è®¤æ‰“å¼€æ­¤é¡µé¢
  - `reactivity` å“åº”å¼ç³»ç»Ÿ
- `vue3`

  `Vue.js 3` å®Œæ•´ä»£ç ä»¥åŠå¯¹åº”çš„æµ‹è¯•ä»£ç 

# å“åº”ç³»ç»Ÿ

`reactive` ä¸ `effect`å¦‚ä½•å»ºç«‹è”ç³»ï¼Œæ ¸å¿ƒå°±æ˜¯åœ¨è§¦å‘è®¿é—®æ—¶ï¼Œä½¿ç”¨ `track` è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œåœ¨å“åº”å¼å¯¹è±¡çš„å€¼å˜åŒ–æ—¶ï¼Œè§¦å‘æ›´æ–° `trigger`

`ä¾èµ–æ”¶é›†`å°±æ˜¯ä¿å­˜å‰¯ä½œç”¨å‡½æ•°ä¸å“åº”å¼å¯¹è±¡çš„å…³ç³»

`è§¦å‘æ›´æ–°`å°±æ˜¯å½“å“åº”å¼å¯¹è±¡å˜åŒ–æ—¶æ‰¾åˆ°å¹¶æ‰§è¡Œä¾èµ–äºä»–çš„å‰¯ä½œç”¨å‡½æ•°

1. æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
2. è®¿é—®å“åº”å¼å¯¹è±¡è¿‡ç¨‹ä¸­å‘ç°ä¾èµ–ï¼Œä¿å­˜å“åº”å¼å¯¹è±¡æ‰€å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä¾èµ–æ”¶é›†
3. å“åº”å¼å¯¹è±¡çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘æ›´æ–°

## âš›ï¸ effect

```js
// targetMap:{ // WeakMap å¯¹è±¡
//   [target]: {
//     [key]: []
//   }
// }
```

âœ… **ä¸ºä»€ä¹ˆä½¿ç”¨ `WeakMap`**

å½“ `reactiveObject` ä¸å†ä½¿ç”¨åï¼Œä¸å¿…æ‰‹åŠ¨å» `WeakMap` é‡Œåˆ é™¤ï¼Œåƒåœ¾å›æ”¶ç³»ç»Ÿå¯ä»¥è‡ªåŠ¨å›æ”¶

âœ… **åˆ†æ”¯åˆ‡æ¢ `cleanup`**

âœ… **åµŒå¥— `effect` ä¸ `effect` æ ˆ**

æ–°å»º `effectStack` æ ˆç»“æ„æ¥å­˜å‚¨ `effectFn`

âœ… **é¿å…æ— é™é€’å½’å¾ªç¯**

å¦‚æœ `trigger` è§¦å‘æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ä¸åŒï¼Œæ‰è§¦å‘æ‰§è¡Œ

`if (effectFn !== activeEffect) effectsToRun.add(effectFn)`

âœ… **è°ƒåº¦æ‰§è¡Œ**

æ‰€è°“å¯è°ƒåº¦ï¼Œå°±æ˜¯å½“ trigger åŠ¨ä½œè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œæ—¶ï¼Œæœ‰èƒ½åŠ›å†³å®šå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œçš„æ—¶é—´ã€æ¬¡æ•°åŠæ–¹å¼

`effect(()=>{},{ scheduler(fn) { /* */ } })`

âœ… **hasChanged**

`set` æ‹¦æˆªæ—¶æ¯”è¾ƒæ–°æ—§å€¼ï¼Œä¸ç›¸åŒæ‰è§¦å‘æ›´æ–°

## âš›ï¸ reactive

### ä»£ç†å¯¹è±¡

âœ… **åµŒå¥— `reactive(reactive(obj))`**

åœ¨ `get` æ‹¦æˆªå™¨å¢åŠ  `__isReactive`

âœ… **ä»£ç†å¤šæ¬¡ `let a = reactive(obj), b = reactive(obj)`**

é€šè¿‡ `proxyMap` ç¼“å­˜å·²ä»£ç†è¿‡çš„ `target`

âœ… **åŠ«æŒ `key in obj` æ“ä½œ**

é€šè¿‡ `has` æ‹¦æˆªå‡½æ•°ä»£ç†

âœ… **ä½¿ç”¨ `for...in` å¾ªç¯éå†å¯¹è±¡**

å¦‚æœæ–°å¢ `key` åˆ™ç”¨ `ownKeys` æ‹¦æˆªï¼Œå¦‚æœä¿®æ”¹ `key` åœ¨ `set` é‡Œåšåˆ¤æ–­æ˜¯è®¾ç½®è¿˜æ˜¯æ·»åŠ 

âœ… **æµ…å“åº”ä¸æ·±å“åº”**

æµ…å“åº”ç›´æ¥è¿”å›åŸå§‹å€¼ï¼Œæ·±å“åº”è°ƒç”¨ `reactive` å°†ç»“æœåŒ…è£…æˆå“åº”å¼æ•°æ®åè¿”å›

âœ… **åªè¯»ä¸æµ…åªè¯»**

åŒä¸Šæ¡ï¼Œä½†è¦åœ¨ `set`ã€`deleteProperty`ã€`get` æ‹¦æˆªå‡½æ•°åˆ†åˆ«å¤„ç†

### ä»£ç†æ•°ç»„

âœ… **é€šè¿‡ç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ ï¼š`arr[0]`**

åœ¨ `trigger` ä¸­ï¼Œå¦‚æœæ˜¯ `ADD`ï¼Œåˆ™åœ¨ `depsMap` ä¸­å–å‡º `key` ä¸º `length` çš„ `effectFn` æ·»åŠ åˆ° `effectsToRun` ä¸­

âœ… **è®¿é—®ä¿®æ”¹æ•°ç»„çš„é•¿åº¦ï¼š`arr.length`**

åœ¨ `trigger` ä¸­ï¼Œå¦‚æœæ˜¯æ•°ç»„ä¸” `key` ä¸º `length`ï¼Œåˆ™åœ¨ `depsMap` ä¸­å–å‡º `newLength < key` çš„ `effects` éå†æ·»åŠ åˆ° `effectsToRun` ä¸­

âœ… **æŠŠæ•°ç»„ä½œä¸ºå¯¹è±¡ï¼Œä½¿ç”¨ `for...in` å¾ªç¯éå†**

å¦‚æœæ˜¯æ•°ç»„åˆ™åœ¨ `ownKeys` æ‹¦æˆªå‡½æ•°ä¸­ï¼Œç”¨ `length` ä½œä¸º `key` å¹¶å»ºç«‹å“åº”è”ç³»

âœ… **ä½¿ç”¨ `for...of` è¿­ä»£éå†æ•°ç»„**

åªè¦åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸æ•°ç»„çš„é•¿åº¦å’Œç´¢å¼•ç›´æ¥å»ºç«‹å“åº”è”ç³»å³å¯ï¼Œä¸Šé¢å‡ æ¡å·²å®ç°

âœ… **æ•°ç»„çš„åŸå‹æ–¹æ³•ï¼Œ`concat/join/every/some/find/findIndex/includes` ç­‰**

é‡å†™æ­¤ç±»æ–¹æ³•ï¼Œå…ˆåœ¨ ä»£ç†å¯¹è±¡ä¸ŠæŸ¥æ‰¾ï¼Œæœªæ‰¾åˆ°å†åˆ° raw åŸå§‹æ•°ç»„é‡ŒæŸ¥æ‰¾ Ã

âœ… **éšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„æ ˆæ–¹æ³•ï¼š`push/pop/shift/unshift/splice`**

é‡å†™æ­¤ç±»æ–¹æ³•ï¼Œå› ä¸ºä¼šæ”¹å˜é•¿åº¦ï¼Œæ‰€ä»¥åªæ”¶é›†æ•°ç»„è‡ªèº«çš„å˜åŒ–äº§ç”Ÿçš„ä¾èµ–ã€‚å®šä¹‰ `shouldTrack`ï¼Œåœ¨æ‰§è¡Œå‰åèµ‹å€¼ `true` å’Œ `false`ï¼ŒåŒæ—¶åœ¨ `track` ä¸­åˆ¤æ–­æ˜¯å¦åº”è¯¥æ”¶é›†ä¾èµ–

## âš›ï¸ computed

ä¸ `reactive` ç›¸ä¼¼ï¼Œä¸åŒç‚¹ï¼š

âœ… **`computed` ä¸­å‰¯ä½œç”¨å‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œ**

`effect` ç¬¬äºŒä¸ªå‚æ•°å¢åŠ  `options.lazy = true`

âœ… **ä¾èµ–æ”¹å˜æ—¶ä¸ä¼šè®¡ç®—ï¼Œåªæœ‰å–çš„æ—¶å€™æ‰ä¼šå»è®¡ç®—**

ä½¿ç”¨ `value`ã€`dirty`ã€`effect` çš„ `scheduler` å‚æ•°æ¥æ§åˆ¶ç¼“å­˜å’Œè®¡ç®—

âœ… **`effect` ä¸­ä½¿ç”¨ `computed` çš„å€¼å¼•å‘ `effect` åµŒå¥—**

å½“è¯»å–è®¡ç®—å±æ€§çš„å€¼æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ `track` è¿›è¡Œè¿½è¸ªï¼›å½“è®¡ç®—å±æ€§å€¼å˜åŒ–æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ `trigger` è§¦å‘å“åº”

## âš›ï¸ watch

æœ¬è´¨æ˜¯è§‚æµ‹ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥å¹¶æ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°

âœ… **æ·±åº¦è§‚æµ‹å¯¹è±¡**

é€’å½’è®¿é—®

âœ… **æ”¯æŒæ¥æ”¶ `getter` å‡½æ•°**

åˆ¤æ–­æ˜¯å¦ä¸ºå‡½æ•°

âœ… **å›è°ƒå‡½æ•°æ¥æ”¶æ—§å€¼ä¸æ–°å€¼**
âœ… **ç«‹å³æ‰§è¡Œçš„ `watch`**

æå– `scheduler` ä¸ºå•ç‹¬çš„ `job` å‡½æ•°ï¼Œå½“ `options.immediate` ä¸º `true` æ—¶ç«‹å³æ‰§è¡Œ `job`

âœ… **å›è°ƒæ‰§è¡Œæ—¶æœº**

å¢åŠ  `options.flush` å‚æ•°ï¼Œå½“ä¸º `post` æ—¶ï¼Œä½¿ç”¨ `Promise.resolve().then(job)` æ‰§è¡Œ `job`ï¼Œ
é»˜è®¤ `sync` ä¸ºç«‹å³æ‰§è¡Œ

âœ… **è¿‡æœŸçš„å‰¯ä½œç”¨**

å¢åŠ  `onInvalidte` å‡½æ•°ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°ä¹‹å‰å…ˆè°ƒç”¨è¿‡æœŸå›è°ƒ

## âš›ï¸ ref

æœ¬è´¨æ˜¯ä¸€ä¸ªâ€œåŒ…è£¹å¯¹è±¡â€ã€‚å› ä¸º `JavaScript` çš„ `Proxy` æ— æ³•æä¾›å¯¹åŸå§‹å€¼çš„ä»£ç†ï¼Œæ‰€ä»¥éœ€è¦ç”¨ä¸€å±‚å¯¹è±¡æ¥åŒ…è£¹ï¼Œç®€ä»‹å®ç°åŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆã€‚ç”±äºâ€œåŒ…è£¹å¯¹è±¡â€æœ¬è´¨ä¸Šä¸æ™®é€šå¯¹è±¡æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä¸ºäº†åŒºåˆ† `ref` ä¸æ™®é€šå¯¹è±¡ï¼Œæˆ‘ä»¬ä¸ºâ€œåŒ…è£¹å¯¹è±¡â€å®šä¹‰äº† `__v_isRef` ä¸º `true` çš„å±æ€§ï¼Œç”¨æ¥è¡¨ç¤º `ref`

âœ… **æ™®é€š `ref`**
âœ… **è§£å†³å“åº”ä¸¢å¤±é—®é¢˜**

å¢åŠ  `toRef`ã€`toRefs`

âœ… **è‡ªåŠ¨è„± `ref`**

# æ¸²æŸ“å™¨

## âš›ï¸ æ¸²æŸ“å™¨è®¾è®¡

âœ… **æ¸²æŸ“å™¨ä¸å“åº”ç³»ç»Ÿçš„ç»“åˆ**

åˆ©ç”¨å“åº”ç³»ç»Ÿçš„èƒ½åŠ›ï¼Œè‡ªåŠ¨è°ƒç”¨æ¸²æŸ“å™¨å®Œæˆé¡µé¢çš„æ¸²æŸ“ä¸æ›´æ–°

âœ… **æ¸²æŸ“å™¨çš„åŸºæœ¬æ¦‚å¿µ**

è™šæ‹Ÿ `DOM` ç”¨ `virtual DOM` æ¥è¡¨è¾¾ï¼Œç®€ç§° `vnode`

æ¸²æŸ“å™¨æŠŠè™šæ‹Ÿ `DOM` èŠ‚ç‚¹æ¸²æŸ“ä¸ºçœŸå® `DOM` èŠ‚ç‚¹çš„è¿‡ç¨‹å«åšæŒ‚è½½ï¼Œç”¨ `mount` æ¥è¡¨è¾¾

æ¸²æŸ“å™¨æŠŠå†…å®¹æŒ‚è½½åˆ°ç›®æ ‡å…ƒç´ ï¼Œè¿™ä¸ªç›®æ ‡å…ƒç´ ç§°ä¸º `container`

åœ¨æ¸²æŸ“æ—¶ï¼Œå¯èƒ½ä¼šå¤šæ¬¡è°ƒç”¨ï¼Œç”±äºä¼ å…¥å‰åçš„ `vnode` å€¼ä¸åŒï¼Œæˆ‘ä»¬éœ€è¦ `patch` å‡½æ•°æ¥æ¯”è¾ƒã€å‰ªè£ä¼ è¿›æ¥çš„ `vnode` ï¼Œå†æŒ‚è½½

âœ… **è‡ªå®šä¹‰æ¸²æŸ“å™¨**

ä»¥æµè§ˆå™¨ä¸ºæ¸²æŸ“ç›®æ ‡å¹³å°ï¼Œç¼–å†™ `vnode` ç»“æ„

å°†æµè§ˆå™¨ç‰¹æœ‰ `API` æŠ½ç¦»ä¸ºé…ç½®é¡¹ï¼Œè¯¥é…ç½®é¡¹å¯ä»¥ä½œä¸º `createRenderer` å‡½æ•°çš„å‚æ•°

## âš›ï¸ æŒ‚è½½ä¸æ›´æ–°

âœ… **æŒ‚è½½å­èŠ‚ç‚¹å’Œå…ƒç´ çš„å±æ€§**

æŒ‚è½½æ—¶ï¼Œå¦‚æœ `children` å­å…ƒç´ ä¸ºæ•°ç»„ï¼Œè¦éå†è°ƒç”¨ `patch` é‡æ–°æŒ‚è½½

å¦‚æœå­˜åœ¨ `props` ï¼Œä½¿ç”¨ `el[key] = vnode.props[key]` ç›´æ¥è®¾ç½® ï¼Ÿ

âœ… **HTML Attributes ä¸ DOM Properties**

**`HTML Attributes` çš„ä½œç”¨æ˜¯è®¾ç½®ä¸ä¹‹å¯¹åº”çš„åˆå§‹å€¼**ã€‚ä¸€æ—¦å€¼æ”¹å˜ï¼Œé‚£ä¹ˆ `DOM Properties` å§‹ç»ˆå­˜å‚¨å½“å‰å€¼ï¼Œè€Œé€šè¿‡ `getAttribute` å‡½æ•°å¾—åˆ°çš„å€¼ä¾ç„¶æ˜¯åˆå§‹å€¼

âœ… **æ­£ç¡®åœ°è®¾ç½®å…ƒç´ å±æ€§**

å…ˆè·å– `el` æœ¬èº« `key` çš„ç±»å‹ï¼Œæ¯”å¦‚ `disabled`

å¦‚æœ `disabled` åœ¨ `el` ä¸Šå­˜åœ¨ï¼Œå¹¶ä¸” `el[disabled]` çš„ç±»å‹æ˜¯ `Boolean` ä¸” `vnode.props.disabled` ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œ
åˆ™æ‰‹åŠ¨ç½®ä¸º `true`ï¼Œå¦åœ¨ç›´æ¥ä½¿ç”¨ `el[key] = value` è®¾ç½®ã€‚æ­¤æ­¥éª¤å¯æŠ½è±¡ä¸º `shouldSetAsProps`

å¦‚æœ `vnode.props` ä¸­çš„å±æ€§ä¸å…·æœ‰å¯¹åº”çš„ `DOM Properties`ï¼Œåˆ™ä½¿ç”¨ `setAttribute` æ¥å®Œæˆå±æ€§è®¾ç½®

âœ… **class çš„å¤„ç†**

```js
class: 'foo bar'
class: { foo: true, bar: true }
class: ['foo', { bar: true }]
```

åˆ†åˆ«é’ˆå¯¹ä¸‰ç§æƒ…å†µè¿›è¡Œæ ¼å¼åŒ–ï¼Œæœ€åè°ƒç”¨ `el.className = 'foo bar'` è¿›è¡Œè®¾ç½®

ğŸŸ¥ **style çš„å¤„ç†**

ä¸ `class` ç±»ä¼¼

âœ… **å¸è½½æ“ä½œ**

æŠŠ `el` å’Œ `vnode` ç»‘å®šèµ·æ¥ï¼Œæ›´æ–°æ—¶å¦‚æœæ— æ–° `vnode` ï¼Œåˆ™å¸è½½

æŠŠå¸è½½å‡½æ•°å°è£…èµ·æ¥ï¼Œå› ä¸ºåé¢è¦æ¸…é™¤ `el` äº‹ä»¶ã€è°ƒç”¨ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç­‰

âœ… **åŒºåˆ† vnode çš„ç±»å‹**

åœ¨æ›´æ–°æ—¶åˆ¤æ–­ `vnode.type` åšä¸åŒçš„ `patch`

âœ… **äº‹ä»¶çš„å¤„ç†**

çº¦æŸåœ¨ `props` ä¸­ä»¥ `on` å¼€å¤´çš„éƒ½ç®—ä½œäº‹ä»¶

ä¼ªé€ ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•° `invoker` ï¼Œå°† `invoker` ç»‘å®šåˆ° `addEventListener` ä¸Šã€‚åœ¨æ¯æ¬¡æ›´æ–°äº‹ä»¶æ—¶æ›´æ–° `invoker` çš„ `value` å³å¯

ä½¿ç”¨ `invoker` æ—¢å¯ä»¥æå‡æ€§èƒ½ä¹Ÿå¯ä»¥è§£å†³äº‹ä»¶å†’æ³¡ä¸äº‹ä»¶æ›´æ–°ç›´æ¥ç›¸äº’å½±å“çš„é—®é¢˜( ğŸ“ **invoker ç›¸å…³ä»£ç æå…¶å·§å¦™ï¼Œå¯ä»¥å“å°ä¸€ä¸‹** )

âœ… **äº‹ä»¶å†’æ³¡ä¸æ›´æ–°æ—¶æœºé—®é¢˜**

å¯èƒ½å­˜åœ¨å­å…ƒç´ ç‚¹å‡»äº‹ä»¶å‘ç”Ÿåå†’æ³¡åˆ°çˆ¶å…ƒç´ ï¼Œä½†çˆ¶å…ƒç´ åˆå§‹å¹¶æ²¡æœ‰ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œè€Œæ˜¯åœ¨ä¸ç¡®å®šçš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ç»‘å®šçš„ï¼Œæ‰€ä»¥ä¼šè§¦å‘çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶ã€‚

æ‰€ä»¥åªè¦å±è”½ç»‘å®šäº‹ä»¶æ™šäºäº‹ä»¶è§¦å‘æ—¶é—´çš„äº‹ä»¶å¤„ç†å‡½æ•°å³å¯ï¼š

åœ¨ç»‘å®šæ—¶ä½¿ç”¨ `performance.now()` æ¥è®°å½•ç»‘å®šæ—¶é—´ (**è®°å½•ä»é¡µé¢åˆå§‹åŒ–å®Œæˆåˆ°ç»‘å®šæ—¶æ‰€ç»è¿‡çš„çš„æ—¶é•¿ï¼Œç²¾åº¦å¯è¾¾å¾®ç§’çº§**) ï¼Œ

åœ¨è§¦å‘æ—¶ä½¿ç”¨ `e.timeStamp` æ¥è·å–è§¦å‘æ—¶é—´ (**è®°å½•ä»é¡µé¢åˆå§‹åŒ–å®Œæˆåˆ°ç”¨æˆ·ç‚¹å‡»çš„é‚£ä¸€åˆ»æ‰€ç»è¿‡çš„æ—¶é•¿**) ï¼Œæ¯”è¾ƒä¸¤è€…æ—¶é—´å³å¯

âœ… **æ›´æ–°å­èŠ‚ç‚¹**

1ï¸âƒ£ æ ¹æ®æ–°æ—§èŠ‚ç‚¹æ›´æ–° `props`

2ï¸âƒ£ æ›´æ–° `children`

- æ–° `children` ç±»å‹ä¸º `String`

  æ—§ `children` ç±»å‹ä¸º `Array` ï¼šéå†æ—§èŠ‚ç‚¹å¸è½½åæ›¿æ¢

  æ—§ `children` ç±»å‹ä¸º `String`ï¼šç›´æ¥æ›¿æ¢

  æ—§ `children` ç±»å‹ä¸º ç©º ï¼šç›´æ¥æ›¿æ¢

- æ–° `children` ç±»å‹ä¸º `Array`

  æ—§ `children` ç±»å‹ä¸º `Array` ï¼š**Diff ç®—æ³•**

  æ—§ `children` ç±»å‹ä¸º `String`ï¼šç›´æ¥æ›¿æ¢

  æ—§ `children` ç±»å‹ä¸º ç©º ï¼šç›´æ¥æ›¿æ¢

- æ–° `children` ç±»å‹ä¸º ç©º

  æ—§ `children` ç±»å‹ä¸º `Array` ï¼šéå†æ—§èŠ‚ç‚¹å¸è½½

  æ—§ `children` ç±»å‹ä¸º `String`ï¼šæ¸…ç©º

  æ—§ `children` ç±»å‹ä¸º ç©º ï¼šéƒ½ä¸ºç©ºï¼Œä»€ä¹ˆä¹Ÿä¸åš

âœ… **æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹**

ç”¨ `Symbol()` å¢åŠ æ–‡æœ¬å’Œæ³¨é‡ŠèŠ‚ç‚¹çš„ç±»å‹ï¼Œåœ¨ `patch` é˜¶æ®µåšåˆ¤æ–­ã€‚å¯¹äºä½¿ç”¨åˆ°çš„ `DOM` æ“ä½œå°è£…èµ·æ¥

âœ… **Fragment**

- ä¸ºä»€ä¹ˆå­˜åœ¨ï¼Ÿ

`Vue.js 2` ä¸­å¿…é¡»ä¸”åªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥å°è£… `option` è¿™æ ·çš„ç»„ä»¶å°±åªèƒ½å¤–é¢åŠ ä¸€å±‚ `template`

```js
<template>
  <li>1</li>
  <li>2</li>
  <li>3</li>
</template>
```

æˆ–è€…

```js
 <Li v-for="item in list">
```

ç”¨ `Symbol()` å¢åŠ  `Fragment` çš„ç±»å‹ï¼Œåœ¨ `patch` é˜¶æ®µåšåˆ¤æ–­

- æ—§ `vnode` ä¸å­˜åœ¨

  åªéœ€å°† `Fragment` çš„ `children` é€ä¸ªæŒ‚è½½

- å­˜åœ¨

  åªéœ€æ›´æ–° `Fragment` çš„ `children` å³å¯

ğŸ“¢ `unmount` å‡½æ•°ä¹Ÿè¦æ”¯æŒå¯¹ `Fragment` ç±»å‹çš„å¤„ç†

## âš›ï¸ ç®€å• Diff ç®—æ³•

```js
const oldVnode = [
  {
    type: 'p',
    key: 1,
    children: '1'
  },
  {
    type: 'p',
    key: 2,
    children: '2'
  },
  {
    type: 'p',
    key: 3,
    children: '3'
  }
]

const newVnode = [
  {
    type: 'p',
    key: 3,
    children: '3'
  },
  {
    type: 'p',
    key: 1,
    children: '2'
  },
  {
    type: 'p',
    key: 2,
    children: '2'
  }
]
```

âœ… **å‡å°‘ DOM æ“ä½œçš„æ€§èƒ½å¼€é”€**

ä¸è¦é‡å¤çš„é”€æ¯å’Œåˆ›å»º `DOM` ï¼Œè¦æ‰¾åˆ°å¯ä»¥å¤ç”¨çš„ `DOM` èŠ‚ç‚¹

âœ… **DOM å¤ç”¨ä¸ key çš„ä½œç”¨**

ç”¨ `key` æ˜¯å¦ç›¸ç­‰æ¥ä»£è¡¨è¿™ä¸ª `DOM` å¯ä»¥å¤ç”¨

å¾ªç¯æ–°èŠ‚ç‚¹ï¼Œåœ¨æ—§èŠ‚ç‚¹ä¸­æ‰¾åˆ° `key` ç›¸åŒçš„èŠ‚ç‚¹ï¼Œå°±ä»£è¡¨å¯ä»¥æ­¤æ—§èŠ‚ç‚¹å¯ä»¥å¤ç”¨ã€‚

- å¦‚æœ `key` ç›¸åŒï¼Œåˆ™ `patch` ï¼Œæ›´æ–°å†…å®¹

âœ… **æ‰¾åˆ°éœ€è¦ç§»åŠ¨çš„å…ƒç´ **

åœ¨å¾ªç¯å¼€å§‹å‰å®šä¹‰ `lastIndex`

- æ¯æ¬¡å¾ªç¯å¦‚æœ `index < lastIndex` ï¼Œè¯´æ˜æ­¤èŠ‚ç‚¹éœ€è¦ç§»åŠ¨
- å¦åˆ™ `lastIndex = index`

âœ… **å¦‚ä½•ç§»åŠ¨å…ƒç´ **

æ‰¾åˆ°ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœä¸Šä¸€ä¸ªèŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ `insert`

âœ… **æ·»åŠ æ–°å…ƒç´ **

åœ¨å¾ªç¯æ–°èŠ‚ç‚¹æ—¶ï¼Œæ¯å±‚éƒ½å®šä¹‰ `find = false`

å¦‚æœæ‰¾åˆ° `key` ç›¸ç­‰çš„åˆ™è¯´æ˜æœ‰å¯ä»¥å¤ç”¨çš„èŠ‚ç‚¹ï¼Œ `find = true` ã€‚å¦åˆ™æ‰§è¡Œ `patch` æŒ‚è½½

âœ… **ç§»é™¤ä¸å­˜åœ¨çš„å…ƒç´ **

æ–°èŠ‚ç‚¹å¾ªç¯ç»“æŸåï¼Œå•ç‹¬å¾ªç¯æ—§èŠ‚ç‚¹ï¼Œå¦‚æœæ‰¾ä¸åˆ° `key` ç›¸ç­‰çš„ï¼Œè¯´æ˜æ­¤æ—§èŠ‚ç‚¹ä¸éœ€è¦å¤ç”¨ï¼Œæ‰§è¡Œå¸è½½æ“ä½œ

## âš›ï¸ åŒç«¯ Diff ç®—æ³•

âœ… **åŒç«¯æ¯”è¾ƒçš„åŸç†**

æ˜¯ä¸€ç§å¯¹æ–°æ—§ä¸¤ç»„å­èŠ‚ç‚¹çš„ä¸¤ä¸ªç«¯ç‚¹è¿›è¡Œæ¯”è¾ƒçš„ç®—æ³•

åˆ¤æ–­æ˜¯å¦ç¬¦åˆ while(oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) ï¼Œé€ä¸ªè¿›è¡Œä¸‹é¢å››ä¸ªæ¡ä»¶åˆ†æ”¯

- if(oldStartIdx.key === newStartIdx.key)

æ–°æ—§**å¤´éƒ¨èŠ‚ç‚¹**ç›¸åŒï¼Œåªéœ€è¦ patch åŠæ›´æ–°ç´¢å¼•

- if(oldEndIdx.key === newEndIdx.key)

æ–°æ—§**å°¾éƒ¨èŠ‚ç‚¹**ç›¸åŒï¼Œåªéœ€è¦ patch åŠæ›´æ–°ç´¢å¼•

- if(oldStartIdx.key === newEndIdx.key)

**æ–°å°¾éƒ¨èŠ‚ç‚¹**ä¸**æ—§å¤´éƒ¨èŠ‚ç‚¹**ç›¸åŒï¼Œéœ€è¦æ›´æ–° patchã€ç§»åŠ¨æ—§èŠ‚ç‚¹åˆ° oldEndVnode.el.nextSibling åã€æ›´æ–°ç´¢å¼•

- if(oldEndIdx.key === newStartIdx.key)

**æ–°å¤´éƒ¨èŠ‚ç‚¹**ä¸**æ—§å°¾éƒ¨èŠ‚ç‚¹**ç›¸åŒï¼Œéœ€è¦æ›´æ–° patchã€ç§»åŠ¨æ—§èŠ‚ç‚¹åˆ° oldStartVnode.el å‰ã€æ›´æ–°ç´¢å¼•

âœ… **åŒç«¯æ¯”è¾ƒçš„ä¼˜åŠ¿**

å¯ä»¥å‡å°‘å¯¹ DOM ç§»åŠ¨çš„æ“ä½œ

âœ… **éç†æƒ³çŠ¶å†µçš„å¤„ç†æ–¹å¼**

åœ¨æ—§èŠ‚ç‚¹ä¸­å¯»æ‰¾ node.key === newStartVNode.key çš„èŠ‚ç‚¹ä½œä¸ºè¦ç§»åŠ¨çš„èŠ‚ç‚¹çš„ç´¢å¼• idxInOld

æ¥ä¸‹æ¥è¿›è¡Œ patchã€ç§»åŠ¨åˆ° oldStartVNode.el å‰ã€å°† oldChildren[idxInOld] ç½®ä½ undefinedã€æ›´æ–°ç´¢å¼•

âœ… **æ·»åŠ æ–°å…ƒç´ **
åœ¨ä¸Šä¸€æ­¥åŸºç¡€ä¸Šï¼Œå¢åŠ  idxInOld å°äº 0 ï¼Œä¹Ÿå°±æ˜¯æ²¡æ‰¾åˆ°çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯æ–°å¢ï¼Œè°ƒç”¨ patch(null, newStartVNode, container, oldStartVNode.el)ã€æ›´æ–°ç´¢å¼•

å¹¶ä¸”åœ¨ while ç»“æŸåï¼Œè¿˜è¦è€ƒè™‘ oldEndIdx < oldStartIdx && newStartIdx <= newEndIdx çš„æƒ…å†µï¼Œè¯´æ˜æ›´æ–°è¿‡ç¨‹ä¸­æœ‰é—æ¼æ–°èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¾ªç¯é—æ¼çš„æ–°èŠ‚ç‚¹è¿›è¡ŒæŒ‚è½½

âœ… **ç§»é™¤ä¸å­˜åœ¨çš„å…ƒç´ **

åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œå¢åŠ  newEndIdx < newStartIdx && oldStartIdx <= oldEndIdx çš„æƒ…å†µï¼Œè¯´æ˜åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæœ‰é—æ¼æ—§èŠ‚ç‚¹ï¼Œè¯´æ˜åº”è¯¥è¿›è¡Œå¸è½½

## âš›ï¸ å¿«é€Ÿ Diff ç®—æ³•

[inferno æ‰€é‡‡ç”¨çš„æ ¸å¿ƒ Diff ç®—æ³•åŠåŸç†](https://hcysunyang.github.io/vue-design/zh/renderer-diff.html#inferno-%E6%89%80%E9%87%87%E7%94%A8%E7%9A%84%E6%A0%B8%E5%BF%83-diff-%E7%AE%97%E6%B3%95%E5%8F%8A%E5%8E%9F%E7%90%86)

å¿«é€Ÿ Diff ç®—æ³•åŒ…å«é¢„å¤„ç†æ­¥éª¤ï¼Œè¿™æ˜¯å€Ÿé‰´äº†çº¯æ–‡æœ¬ Diff ç®—æ³•çš„æ€è·¯

âœ… **ç›¸åŒçš„å‰ç½®å…ƒç´ å’Œåç½®å…ƒç´ **

1. ä»å‰å¾€åä¾æ¬¡å¯¹æ¯”ï¼Œè°ƒç”¨ patch æ›´æ–°ç›¸åŒçš„**å‰ç½®èŠ‚ç‚¹**

2. ä»åå¾€å‰ä¾æ¬¡å¯¹æ¯”ï¼Œè°ƒç”¨ patch æ›´æ–°ç›¸åŒçš„**åç½®èŠ‚ç‚¹**

3. å¦‚æœæ—§èŠ‚ç‚¹éå†å®Œ æ–°èŠ‚ç‚¹æ²¡éå†å®Œï¼Œéœ€è¦æŒ‚è½½ï¼Œç”¨ (j > oldEnd && j <= newEnd) æ¥åˆ¤æ–­

4. å¦‚æœæ–°èŠ‚ç‚¹éå†å®Œ æ—§èŠ‚ç‚¹æ²¡éå†å®Œï¼Œéœ€è¦å¸è½½ï¼Œç”¨ (j > newEnd && j <= oldEnd) æ¥åˆ¤æ–­

âœ… **åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œ DOM ç§»åŠ¨æ“ä½œ**

5. è‹¥éƒ½ä¸ç¬¦åˆä¸Šé¢çš„æ¡ä»¶ï¼Œæ–°å¢ else åˆ†æ”¯

é‡‡ç”¨ä¼ ç»Ÿ Diff ç®—æ³•ï¼Œä½†ä¸çœŸæ­£çš„æ·»åŠ å’Œç§»åŠ¨ï¼Œåªæ˜¯åšæ ‡è®°å’Œåˆ é™¤

å®šä¹‰ source æ•°ç»„å¡«å…… -1

å®šä¹‰ keyIndex ç´¢å¼•è¡¨ã€‚å¾ªç¯ j - newEnd ä»¥ vnode.key ä¸ºé”®ï¼Œä»¥ç´¢å¼•ä¸ºå€¼æ„å»ºç´¢å¼•è¡¨

åˆ›å»ºå˜é‡ moved ä½œä¸ºæ ‡è¯†ï¼Œå½“å€¼ä¸º true æ—¶è¯´æ˜éœ€è¦è¿›è¡Œç§»åŠ¨ï¼Œå¦‚æœåœ¨éå†è¿‡ç¨‹ä¸­é‡åˆ°çš„ç´¢å¼•å€¼å‘ˆé€’å¢è¶‹åŠ¿ï¼Œåˆ™è¯´æ˜ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ï¼Œåä¹‹åˆ™éœ€è¦

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€ä¸€ä¸ªæ•°é‡æ ‡è¯†ä»£è¡¨**å·²ç»æ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡**ï¼Œå·²ç»æ›´æ–°çš„æ•°é‡åº”è¯¥å°äºæ–°çš„ä¸€ç»„å­èŠ‚ç‚¹éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœè¶…è¿‡åˆ™ä»£è¡¨éœ€è¦å¸è½½

âœ… **å¦‚ä½•ç§»åŠ¨å…ƒç´ **

6. æ ¹æ® source æ•°ç»„è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ— seqï¼ˆseq é‡Œé¢æ˜¯é€’å¢çš„ï¼Œæ‰€ä»¥ç¬¦åˆçš„éƒ½ä¸ç”¨ç§»åŠ¨ï¼‰

ä»åå¾€å‰å¾ªç¯ source

å¦‚æœ source[i] === -1 ï¼Œè¯´æ˜æ˜¯æ–°å…ƒç´ ï¼Œè¿›è¡ŒæŒ‚è½½æ“ä½œ

å¦‚æœ seq[s] !== i ï¼Œè¯´æ˜ä¸åœ¨é€’å¢å­åºåˆ—é‡Œé¢ï¼Œéœ€è¦ç§»åŠ¨

å¦åˆ™ s--

âœ… **æœ€é•¿é€’å¢å­åºåˆ—**

```js
// åŠ¨æ€è§„åˆ’ O(n^2)
function lengthOfLIS(nums: number[]): number {
  const dp = new Array(nums.length).fill(1)
  let max = 1
  for (let i = 0; i < nums.length; i++) {
    for (let j = 0; j < i; j++) {
      if (nums[i] > nums[j]) {
        dp[i] = Math.max(dp[j] + 1, dp[i])
      }
    }
    max = Math.max(max, dp[i])
  }

  return max
}
// è´ªå¿ƒ O(n^2)
// ä¿æŒå±€éƒ¨é€’å¢ï¼Œåˆ™å…¨å±€é€’å¢
function lengthOfLIS(nums: number[]): number {
  const arr = [nums[0]]
  for (let i = 1; i < nums.length; i++) {
    // æ¯”å·²ä¿å­˜çš„æœ€åä¸€ä¸ª å°
    if (nums[i] <= arr[arr.length - 1]) {
      for (let j = 0; j < arr.length; j++) {
        if (arr[j] >= nums[i]) {
          arr[j] = nums[i]
          break
        }
      }
    } else {
      arr.push(nums[i])
    }
  }
  return arr.length
}
// è´ªå¿ƒ + äºŒåˆ† O(nlogn)
function lengthOfLIS(nums: number[]): number {
  const arr = [nums[0]]
  for (let i = 1; i < nums.length; i++) {
    // æ¯”å·²ä¿å­˜çš„æœ€åä¸€ä¸ª å°
    if (nums[i] <= arr[arr.length - 1]) {
      let l = 0
      let r = arr.length - 1
      while (l <= r) {
        const mid = Math.round((r + l) / 2)
        if (arr[mid] < nums[i]) {
          // è¦æ‰¾çš„æ•°å­—åœ¨å³åŠåŒº
          l = mid + 1
        } else if (arr[mid] > nums[i]) {
          // è¦æ‰¾çš„æ•°å­—åœ¨å·¦åŠåŒº
          r = mid - 1
        } else {
          // æ‰¾åˆ°è¿™ä¸ªæ•°å­—äº†
          l = mid
          break
        }
      }
      arr[l] = nums[i]
    } else {
      arr.push(nums[i])
    }
  }
  return arr.length
}

// é€‚ç”¨äº Diff ç®—æ³•çš„å¯»æ‰¾æœ€é•¿å­åºåˆ—
function getSequence(nums) {
  let arr = []
  let position = []
  for (let i = 0; i < nums.length; i++) {
    // å¯¹éœ€è¦æŒ‚è½½çš„ -1 åšäº†å¤„ç†
    if (nums[i] === -1) {
      continue
    }
    // arr[arr.length - 1]å¯èƒ½ä¸ºundefinedï¼Œæ­¤æ—¶nums[i] > undefinedä¸ºfalse
    if (nums[i] > arr[arr.length - 1]) {
      arr.push(nums[i])
      position.push(arr.length - 1)
    } else {
      let l = 0,
        r = arr.length - 1
      while (l <= r) {
        let mid = ~~((l + r) / 2)
        if (nums[i] > arr[mid]) {
          l = mid + 1
        } else if (nums[i] < arr[mid]) {
          r = mid - 1
        } else {
          l = mid
          break
        }
      }
      arr[l] = nums[i]
      position.push(l)
    }
  }
  let cur = arr.length - 1
  // è¿™é‡Œå¤ç”¨äº†arrï¼Œå®ƒæœ¬èº«å·²ç»æ²¡ç”¨äº†
  for (let i = position.length - 1; i >= 0 && cur >= 0; i--) {
    if (position[i] === cur) {
      arr[cur--] = i
    }
  }
  return arr
}
```

âœ… **æ€»ç»“**

å¿«é€Ÿ Diff ç®—æ³•åœ¨å®æµ‹ä¸­æ€§èƒ½æœ€ä¼˜ã€‚å®ƒå€Ÿé‰´äº†æ–‡æœ¬ Diff ä¸­çš„é¢„å¤„ç†æ€è·¯ï¼Œå…ˆå¤„ç†æ–°æ—§ä¸¤ç»„å­èŠ‚ç‚¹ä¸­ç›¸åŒçš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹ã€‚å½“å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹å…¨éƒ¨å¤„ç†å®Œæ¯•åï¼Œå¦‚æœæ— æ³•ç®€å•åœ°é€šè¿‡æŒ‚è½½æ–°èŠ‚ç‚¹æˆ–è€…å¸è½½å·²ç»ä¸å­˜åœ¨çš„èŠ‚ç‚¹æ¥å®Œæˆæ›´æ–°ï¼Œåˆ™éœ€è¦æ ¹æ®èŠ‚ç‚¹çš„ç´¢å¼•å…³ç³»ï¼Œæ„é€ å‡ºä¸€ä¸ªæœ€é•¿é€’å¢å­åºåˆ—ã€‚æœ€é•¿é€’å¢å­åºåˆ—æ‰€æŒ‡å‘çš„èŠ‚ç‚¹å³ä¸ºä¸éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹
